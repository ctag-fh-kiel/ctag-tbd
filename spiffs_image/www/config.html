<ons-page id="config">
    <ons-toolbar>
        <div class="left">
            <ons-back-button>Config</ons-back-button>
        </div>
        <div class="center">TBD Setup</div>
    </ons-toolbar>
    <ons-list-header>CV0 Config</ons-list-header>
    <ons-list-item>
        <ons-select id="cv0-config">
            <option value="unipolar">Unipolar 0 .. 5V</option>
            <option value="bipolar">Bipolar -5 .. 5V</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CV1 Config</ons-list-header>
    <ons-list-item>
        <ons-select id="cv1-config">
            <option value="unipolar">Unipolar 0 .. 5V</option>
            <option value="bipolar">Bipolar -5 .. 5V</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>Pot 0 Config</ons-list-header>
    <ons-list-item>
        <ons-select id="cv2-config">
            <option value="unipolar">Unipolar 0 .. 1</option>
            <option value="bipolar">Bipolar -1 .. 1</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>Pot 1 Config</ons-list-header>
    <ons-list-item>
        <ons-select id="cv3-config">
            <option value="unipolar">Unipolar 0 .. 1</option>
            <option value="bipolar">Bipolar -1 .. 1</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>Input Noise Gate</ons-list-header>
    <ons-list-item>
        <ons-select id="ng-config">
            <option value="off">Off</option>
            <option value="dual">Both channels</option>
            <option value="ch0">Channel 0</option>
            <option value="ch1">Channel 1</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH0 To CH1 Daisy Chain</ons-list-header>
    <ons-list-item>
        <ons-select id="ch01-daisy">
            <option value="off">Off</option>
            <option value="on">On</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH0 To Stereo</ons-list-header>
    <ons-list-item>
        <ons-select id="ch0-stereo-config">
            <option value="off">Off</option>
            <option value="on">On</option>
            <option value="mix">Mix with CH1</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH1 To Stereo</ons-list-header>
    <ons-list-item>
        <ons-select id="ch1-stereo-config">
            <option value="off">Off</option>
            <option value="on">On</option>
            <option value="mix">Mix with CH0</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH0 Soft Clip Output</ons-list-header>
    <ons-list-item>
        <ons-select id="ch0-sco-config">
            <option value="off">Off</option>
            <option value="on">On</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH1 Soft Clip Output</ons-list-header>
    <ons-list-item>
        <ons-select id="ch1-sco-config">
            <option value="off">Off</option>
            <option value="on">On</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>Codec Output Levels (58 for 10Vpp modular, 1dB Steps)</ons-list-header>
    <ons-list-item>
        <div>
            Left:<input style="margin-right:1em;" id="ch0-codec-lvl-out" placeholder="58" type="number" min="0" max="63" step="1"></input>
        </div>
        <div>
            Right:<input style="margin-right:1em;" id="ch1-codec-lvl-out" placeholder="58" type="number" min="0" max="63" step="1"></input>
        </div>
    </ons-list-item>
    <ons-list-header>Wifi Configuration</ons-list-header>
    <ons-list-item>
        <div style="text-align: center; margin-top: 10px;">
            <ons-select id="wifi-mode">
                <option value="ap">Access Point</option>
                <option value="sta">Station</option>
            </ons-select>
            <p>
            <div>SSID</div><ons-input id="ssid" modifier="underbar" placeholder="SSID" float></ons-input>
            </p>
            <p>
            <div>Password</div><ons-input id="pwd" modifier="underbar" placeholder="Password" float></ons-input>
            </p>
            <p>
            <div>mDNS Name</div><ons-input id="mdns-name" modifier="underbar" placeholder="mDNS Name" float></ons-input>
            </p>
            <ons-button id="commit-wifi" style="margin-top: 30px;">Commit WiFi data</ons-button>
        </div>
    </ons-list-item>
    <ons-list-header>System Backup</ons-list-header>
    <ons-list-item>
        <div style="text-align: center; margin-top: 10px;">
            <ons-button id="download-backup" style="margin-top: 10px;">Download Backup</ons-button>
            <ons-button id="upload-backup" style="margin-top: 10px;">Upload Backup</ons-button>
            <input id="uploadBackup" type="file" hidden/>
        </div>
    </ons-list-item>
    <ons-list-header>Firmware upgrade</ons-list-header>
    <ons-list-item>
        <div style="text-align: left;">
            <ons-progress-bar id="fw-progress" value="0" secondary-value="0"></ons-progress-bar>
            <label for="app-binary">ctag-tbd.bin</label><input id="app-binary" type="file"/>
            <label for="spiffs-binary">storage.bin</label><input id="spiffs-binary" type="file"/>
            <ons-button id="upgrade-firmware" style="margin-top: 10px;">Upgrade Firmware</ons-button>
        </div>
    </ons-list-item>
    <ons-list-header>System Reboot</ons-list-header>
    <ons-list-item>
        <div style="text-align: center; margin-top: 10px;">
            <ons-button id="reboot" style="margin-top: 10px;">Reboot</ons-button>
            <ons-button id="reboot-calibration" style="margin-top: 10px;">Reboot, calibrate CVs</ons-button>
        </div>
    </ons-list-item>
    <ons-modal direction="down">
        <div style="text-align: left">
            Calibration instructions:
            <ol>
                <li>Single LED pulse</li>
                <ul>
                    <li>Turn knobs all left</li>
                    <li>Apply 0V to CV ins</li>
                    <li>Press trig 0</li>
                </ul>
                <li>Double LED pulse</li>
                <ul>
                    <li>Turn knobs mid position</li>
                    <li>Apply 2.5V to CV ins</li>
                    <li>Press trig 0</li>
                </ul>
                <li>Triple LED pulse</li>
                <ul>
                    <li>Turn knobs all right</li>
                    <li>Apply 5V to CV ins</li>
                    <li>Press trig 0</li>
                </ul>
                <li>Four LED pulses</li>
                <ul>
                    <li>Turn knobs all left</li>
                    <li>Apply -5V to CV ins</li>
                    <li>Press trig 0</li>
                </ul>
                <li>Five LED pulses</li>
                <ul>
                    <li>Turn knobs mid position</li>
                    <li>Apply 0V to CV ins</li>
                    <li>Press trig 0</li>
                </ul>
                <li>Six LED pulses</li>
                <ul>
                    <li>Turn knobs all right</li>
                    <li>Apply 5V to CV ins</li>
                    <li>Press trig 0</li>
                </ul>
                <li>
                    Calibration completed!
                </li>
            </ol>
        </div>
    </ons-modal>
    <script>
        ons.getScriptPage().onInit = function () {
            $.getq('myq', 'api/v1/getConfiguration',
                data => {
                    $('#cv0-config').val(data["cv_ch0"]);
                    $('#cv1-config').val(data["cv_ch1"]);
                    $('#cv2-config').val(data["cv_ch2"]);
                    $('#cv3-config').val(data["cv_ch3"]);
                    $('#ng-config').val(data["ng_config"]);
                    $('#ch01-daisy').val(data["ch01_daisy"]);
                    $('#ch0-stereo-config').val(data["ch0_toStereo"]);
                    $('#ch1-stereo-config').val(data["ch1_toStereo"]);
                    $('#ch0-sco-config').val(data["ch0_outputSoftClip"]);
                    $('#ch1-sco-config').val(data["ch1_outputSoftClip"]);
                    $('#ch0-codec-lvl-out').val(data["ch0_codecLvlOut"]);
                    $('#ch1-codec-lvl-out').val(data["ch1_codecLvlOut"]);
                    $('#wifi-mode').val(data["wifi"].mode);
                    $('#ssid').val(data["wifi"].ssid);
                    $('#pwd').val(data["wifi"].pwd);
                    $('#mdns-name').val(data["wifi"].mdns_name);
                    window.cfgData = data;
                    $('#cv0-config').on('change', function () {
                        cfgData.cv_ch0 = $('#cv0-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#cv1-config').on('change', function () {
                        cfgData.cv_ch1 = $('#cv1-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#cv2-config').on('change', function () {
                        cfgData.cv_ch2 = $('#cv2-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#cv3-config').on('change', function () {
                        cfgData.cv_ch3 = $('#cv3-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ng-config').on('change', function () {
                        cfgData.ng_config = $('#ng-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch01-daisy').on('change', function () {
                        cfgData.ch01_daisy = $('#ch01-daisy').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch0-stereo-config').on('change', function () {
                        cfgData.ch0_toStereo = $('#ch0-stereo-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch1-stereo-config').on('change', function () {
                        cfgData.ch1_toStereo = $('#ch1-stereo-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch0-sco-config').on('change', function () {
                        cfgData.ch0_outputSoftClip = $('#ch0-sco-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch1-sco-config').on('change', function () {
                        cfgData.ch1_outputSoftClip = $('#ch1-sco-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch0-codec-lvl-out').on('change', function () {
                        cfgData.ch0_codecLvlOut = $('#ch0-codec-lvl-out').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch1-codec-lvl-out').on('change', function () {
                        cfgData.ch1_codecLvlOut = $('#ch1-codec-lvl-out').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#commit-wifi').on('click', function () {
                        cfgData.wifi.ssid = $('#ssid').val();
                        cfgData.wifi.pwd = $('#pwd').val();
                        cfgData.wifi.mode = $('#wifi-mode').val();
                        cfgData.wifi.mdns_name = $('#mdns-name').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                        ons.notification.toast('You must reboot the module for changes to take effect!', {
                            timeout: 3000,
                            animation: 'fall'
                        });
                    });
                    $('#download-backup').on('click', function () {
                        loadScript('/js/jszip.min.js', () => {
                            $.getq('myq',
                                'api/v1/getPlugins',
                                data => {
                                    let presets = [];
                                    let calibration = {};
                                    let configuration = {};
                                    $.getq('myq',
                                        'api/v1/getCalibration',
                                        data => {
                                            calibration = data;
                                        }
                                    );
                                    $.getq('myq',
                                        'api/v1/getConfiguration',
                                        data => {
                                            configuration = data;
                                        }
                                    );
                                    for (let i = 0; i < data.length; i++) {
                                        let el = data[i];
                                        if (i == data.length - 1) {
                                            $.getq('myq',
                                                'api/v1/getPresetData/' + el.id,
                                                rdata => {
                                                    let o = {
                                                        id: el.id,
                                                        presets: rdata,
                                                    };
                                                    presets.push(o);
                                                    // last request completed
                                                    let zip = new JSZip();
                                                    presets.forEach(el => {
                                                        zip.file('mp-' + el.id + '.jsn', JSON.stringify(el.presets));
                                                    });
                                                    let all = {
                                                        presets: presets,
                                                        calibration: calibration,
                                                        configuration: configuration
                                                    }
                                                    zip.file('all.jsn', JSON.stringify(all));
                                                    zip.generateAsync({type: "blob"})
                                                        .then(function (content) {
                                                            // see FileSaver.js
                                                            saveAs(content, 'presets.zip');
                                                        });
                                                }
                                            );
                                        } else {
                                            $.getq('myq',
                                                'api/v1/getPresetData/' + el.id,
                                                rdata => {
                                                    let o = {
                                                        id: el.id,
                                                        presets: rdata
                                                    };
                                                    presets.push(o);
                                                }
                                            );
                                        }
                                    }
                                }
                            );
                        });
                    });
                    $('#reboot').on('click', function () {
                        $.getq('myq',
                            '/api/v1/reboot',
                            {'calibration': '0'}
                        );
                        ons.notification.toast('Software reboot!', {
                            timeout: 3000,
                            animation: 'fall'
                        });
                    });
                    $('#reboot-calibration').on('click', function () {
                        $.getq('myq',
                            '/api/v1/reboot',
                            {'calibration': '1'}
                        );
                        document.querySelector('ons-modal').show();
                    });
                    $('#upload-backup').click(function () {
                        ons.notification.toast('Select all.jsn!', {
                            timeout: 3000,
                            animation: 'fall'
                        });
                        $('#uploadBackup').trigger('click');
                    });
                    $('#uploadBackup').on('change', function () {
                        if ($('#uploadBackup').prop('files')[0] == undefined) return;
                        if ($('#uploadBackup').prop('files')[0] == '') return;
                        if ($('#uploadBackup').prop('files')[0] == 0) return;
                        let reader = new FileReader();
                        reader.onload = function (event) {
                            let contents = event.target.result;
                            try {
                                let jsn = JSON.parse(contents);
                                $('#uploadBackup').val('');
                                performUploadBackup(jsn);
                            } catch (e) {
                                ons.notification.toast('Error parsing backup file!', {
                                    timeout: 1000,
                                    animation: 'fall'
                                });
                            }
                        }
                        reader.readAsText($('#uploadBackup').prop('files')[0]);
                    });
                    $('#upgrade-firmware').on('click', function () {
                        let spiffsImage = $('#spiffs-binary').get(0).files[0];
                        let fwImage = $('#app-binary').get(0).files[0];
                        if(spiffsImage == undefined || fwImage == undefined){
                            ons.notification.toast('Binary image files not defined', {
                                timeout: 1000,
                                animation: 'fall'
                            });
                            return;
                        }
                        $('ons-button').each((index, el) => {
                            $(el).attr("disabled", true);
                        });
                        $.ajaxq('myq', {
                            url: '/api/v1/otaAPI/1',
                            type: 'post',
                            data: null,
                            success: function () {
                                ons.notification.toast('Please wait some time until update is completed, I will notify you! DO NOT POWER DOWN!!!', {
                                    timeout: 10000,
                                    animation: 'fall'
                                });
                            },
                            error: function () {
                                ons.notification.toast('Error OTA 1!', {
                                    timeout: 1000,
                                    animation: 'fall'
                                });
                            }
                        });
                        $.ajaxq('myq', {
                            xhr: function()
                            {
                                let xhr = new window.XMLHttpRequest();
                                //Upload progress
                                xhr.upload.addEventListener("progress", function(evt){
                                    if (evt.lengthComputable) {
                                        let percentComplete = evt.loaded / evt.total * 100;
                                        $('#fw-progress').attr('value', percentComplete);
                                        $('#fw-progress').attr('secondary-value', '33');
                                    }
                                }, false);
                                return xhr;
                            },
                            url: '/api/v1/otaAPI/2',
                            type: 'post',
                            data: spiffsImage,
                            processData: false,
                            contentType: false,
                            timeout: 60*1000,
                            success: function () {
                                console.log('OTA init stage 2 success');
                            },
                            error: function () {
                                ons.notification.toast('Error OTA 2!', {
                                    timeout: 1000,
                                    animation: 'fall'
                                });
                            }
                        });
                        $.ajaxq('myq', {
                            xhr: function()
                            {
                                let xhr = new window.XMLHttpRequest();
                                //Upload progress
                                xhr.upload.addEventListener("progress", function(evt){
                                    if (evt.lengthComputable) {
                                        let percentComplete = evt.loaded / evt.total * 100;
                                        $('#fw-progress').attr('value', percentComplete);
                                        $('#fw-progress').attr('secondary-value', '66');
                                    }
                                }, false);
                                return xhr;
                            },
                            url: '/api/v1/otaAPI/3',
                            type: 'post',
                            data: fwImage,
                            processData: false,
                            contentType: false,
                            timeout: 60*1000,
                            success: function () {
                                ons.notification.toast('Please wait some time until update is completed, I will notify you! DO NOT POWER DOWN!!!', {
                                    timeout: 10000,
                                    animation: 'fall'
                                });
                                $('#fw-progress').attr('value', '80');
                                $('#fw-progress').attr('secondary-value', '100');
                            },
                            error: function () {
                                ons.notification.toast('Error OTA 3!', {
                                    timeout: 1000,
                                    animation: 'fall'
                                });
                            }
                        });
                        $.ajaxq('myq', {
                            url: '/api/v1/otaAPI/4',
                            type: 'post',
                            data: null,
                            success: function () {
                                $('#fw-progress').attr('value', '100');
                                $('#fw-progress').attr('secondary-value', '100');
                                ons.notification.toast('Update success, rebooting!', {
                                    timeout: 1000,
                                    animation: 'fall'
                                });
                                setTimeout(function(){location.reload()}, 10000);
                            },
                            error: function () {
                                ons.notification.toast('Error OTA 4!', {
                                    timeout: 1000,
                                    animation: 'fall'
                                });
                            }
                        });
                    });
                }
            );

            this.onShow = function () {
                //console.log('Main');
            };
            // async script loader
            function loadScript(url, cb) {
                let isLoaded = document.querySelectorAll('.search-script');
                if(isLoaded.length > 0) {
                    cb();
                    return;
                }

                let myScript = document.createElement("script");
                myScript.src = url;
                myScript.className = 'search-script';
                myScript.onload = cb;
                document.body.appendChild(myScript);
            }
            function performUploadBackup(data){
                // console.log(JSON.stringify(data.calibration));
                $.ajaxq('myq', {
                    url: '/api/v1/setCalibration',
                    type: 'post',
                    data: JSON.stringify(data.calibration),
                    success: function () {
                        ons.notification.toast('Calibration data persisted!', {
                            timeout: 1000,
                            animation: 'fall'
                        });
                    },
                    error: function () {
                        ons.notification.toast('Error persisting calibration data!', {
                            timeout: 1000,
                            animation: 'fall'
                        });
                    }
                });
                let presets = data.presets;
                presets.forEach(plugin => {
                    if(plugin.presets.patches.length == 0){
                        console.log('No preset data for plugin ' + plugin.id);
                        return;
                    }
                    $.getq('myq',
                        '/api/v1/getPresetData/' + plugin.id,
                        data => {
                            if(typeof data != "object"){
                                console.log('Plugin not available: ' + plugin.id);
                                return;
                            }
                            if(data.patches.length == 0){
                                console.log('No patches available in plugin ' + plugin.id);
                                return;
                            }
                            if(data.patches[0].params.length == 0){
                                console.log('No patches available in plugin ' + plugin.id);
                                return;
                            }
                            // check for parameters not available in backup data set and add
                            data.patches[0].params.forEach(param => {
                                plugin.presets.patches.forEach( p => {
                                    const found = p.params.find(({id}) => id === param.id);
                                    if(found == undefined){
                                        console.log('Unknown new param ' + param.id + ' inserting!');
                                        p.params.push(param);
                                    }
                                });
                            });
                            // check for parameters not available on available plugin of TBD HW and drop
                            plugin.presets.patches.forEach(p => {
                                p.params = p.params.filter(param => {
                                    const found = data.patches[0].params.find(({id}) => id === param.id);
                                    if(found == undefined) console.log('Removing old param ' + param.id);
                                    return found != undefined;
                                });
                                $.postq('myq',
                                    '/api/v1/setPresetData/' + plugin.id,
                                    JSON.stringify(p), 'json');
                            });
                        }
                    );
                });
            }
        };
    </script>
</ons-page>