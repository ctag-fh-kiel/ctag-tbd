<ons-page id="config">
    <ons-toolbar>
        <div class="left">
            <ons-back-button>Config</ons-back-button>
        </div>
        <div class="center">TBD Setup</div>
    </ons-toolbar>
    <ons-list-header>CH0 To CH1 Daisy Chain</ons-list-header>
    <ons-list-item>
        <ons-select id="ch01-daisy">
            <option value="off">Off</option>
            <option value="on">On</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH0 To Stereo</ons-list-header>
    <ons-list-item>
        <ons-select id="ch0-stereo-config">
            <option value="off">Off</option>
            <option value="on">On</option>
            <option value="mix">Mix with CH1</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH1 To Stereo</ons-list-header>
    <ons-list-item>
        <ons-select id="ch1-stereo-config">
            <option value="off">Off</option>
            <option value="on">On</option>
            <option value="mix">Mix with CH0</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH0 Soft Clip Output</ons-list-header>
    <ons-list-item>
        <ons-select id="ch0-sco-config">
            <option value="off">Off</option>
            <option value="on">On</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>CH1 Soft Clip Output</ons-list-header>
    <ons-list-item>
        <ons-select id="ch1-sco-config">
            <option value="off">Off</option>
            <option value="on">On</option>
        </ons-select>
    </ons-list-item>
    <ons-list-header>Codec Output Levels (58 as reference, max. 1V_rms = 0dBV)</ons-list-header>
    <ons-list-item>
        <div>
            Left:<input style="margin-right:1em;" id="ch0-codec-lvl-out" placeholder="58" type="number" min="0" max="63" step="1"></input>
        </div>
        <div>
            Right:<input style="margin-right:1em;" id="ch1-codec-lvl-out" placeholder="58" type="number" min="0" max="63" step="1"></input>
        </div>
    </ons-list-item>
    <ons-list-header>Wifi Configuration</ons-list-header>
    <ons-list-item>
        <div style="text-align: center; margin-top: 10px;">
            <ons-select id="wifi-mode">
                <option value="ap">Access Point</option>
                <option value="sta">Station</option>
                <option value="usbncm">USB Network</option>
            </ons-select>
            <p>
            <div>SSID</div><ons-input id="ssid" modifier="underbar" placeholder="SSID" float></ons-input>
            </p>
            <p>
            <div>Password</div><ons-input id="pwd" modifier="underbar" placeholder="Password" float></ons-input>
            </p>
            <p>
            <div>mDNS Name</div><ons-input id="mdns-name" modifier="underbar" placeholder="mDNS Name" float></ons-input>
            </p>
            <ons-button id="commit-wifi" style="margin-top: 30px;">Commit WiFi data</ons-button>
        </div>
    </ons-list-item>
    <ons-list-header>System Backup</ons-list-header>
    <ons-list-item>
        <div style="text-align: center; margin-top: 10px;">
            <ons-button id="download-backup" style="margin-top: 10px;">Download Backup</ons-button>
            <ons-button id="upload-backup" style="margin-top: 10px;background-color: red">Upload Backup (OVERWRITE!!!)</ons-button>
            <input id="uploadBackup" type="file" hidden/>
        </div>
    </ons-list-item>
    <ons-list-header>Firmware version</ons-list-header>
    <ons-list-item>
        <div style="text-align: left;">
            <div style="color: orangered; margin: 1em" id="version"></div>
        </div>
    </ons-list-item>
    <ons-list-header>System Reboot</ons-list-header>
    <ons-list-item>
        <div style="text-align: center; margin-top: 10px;">
            <ons-button id="reboot" style="margin-top: 10px;">Reboot</ons-button>
        </div>
    </ons-list-item>
    <ons-modal id="modal-busy" direction="up">
        <ons-icon icon="md-spinner" size="28px" spin></ons-icon>
        Processing, please wait!
    </ons-modal>
    <script>
        ons.getScriptPage().onInit = function () {
            let modal_busy = $('#modal-busy');
            $('#version').text('Current FW: ' + window.ioCaps.FWV + " HW: " + window.ioCaps.HWV);
            $.getq('myq', 'api/v1/getConfiguration',
                data => {
                    $('#ch01-daisy').val(data["ch01_daisy"]);
                    $('#ch0-stereo-config').val(data["ch0_toStereo"]);
                    $('#ch1-stereo-config').val(data["ch1_toStereo"]);
                    $('#ch0-sco-config').val(data["ch0_outputSoftClip"]);
                    $('#ch1-sco-config').val(data["ch1_outputSoftClip"]);
                    $('#ch0-codec-lvl-out').val(data["ch0_codecLvlOut"]);
                    $('#ch1-codec-lvl-out').val(data["ch1_codecLvlOut"]);
                    $('#wifi-mode').val(data["wifi"].mode);
                    $('#ssid').val(data["wifi"].ssid);
                    $('#pwd').val(data["wifi"].pwd);
                    $('#mdns-name').val(data["wifi"].mdns_name);
                    window.cfgData = data;
                    $('#ng-config').on('change', function () {
                        cfgData.ng_config = $('#ng-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch01-daisy').on('change', function () {
                        cfgData.ch01_daisy = $('#ch01-daisy').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch0-stereo-config').on('change', function () {
                        cfgData.ch0_toStereo = $('#ch0-stereo-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch1-stereo-config').on('change', function () {
                        cfgData.ch1_toStereo = $('#ch1-stereo-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch0-sco-config').on('change', function () {
                        cfgData.ch0_outputSoftClip = $('#ch0-sco-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch1-sco-config').on('change', function () {
                        cfgData.ch1_outputSoftClip = $('#ch1-sco-config').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch0-codec-lvl-out').on('change', function () {
                        cfgData.ch0_codecLvlOut = $('#ch0-codec-lvl-out').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#ch1-codec-lvl-out').on('change', function () {
                        cfgData.ch1_codecLvlOut = $('#ch1-codec-lvl-out').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                    });
                    $('#commit-wifi').on('click', function () {
                        // if wifi password is shorter than 8 chars, do not commit
                        if($('#pwd').val().length < 8 && $('#pwd').val().length != 0){
                            ons.notification.toast('Password must be at least 8 characters long, or none!', {
                                timeout: 3000,
                                animation: 'fall'
                            });
                            return;
                        }
                        cfgData.wifi.ssid = $('#ssid').val();
                        cfgData.wifi.pwd = $('#pwd').val();
                        cfgData.wifi.mode = $('#wifi-mode').val();
                        cfgData.wifi.mdns_name = $('#mdns-name').val();
                        $.postq('myq', 'api/v1/setConfiguration',
                            JSON.stringify(cfgData), 'json'
                        );
                        ons.notification.toast('You must reboot the module for changes to take effect!', {
                            timeout: 3000,
                            animation: 'fall'
                        });
                    });
                    $('#download-backup').on('click', function () {
                        loadScript('/js/jszip.min.js', () => {
                            modal_busy.show();
                            $.getq('myq',
                                'api/v1/getPlugins',
                                data => {
                                    let presets = [];
                                    let calibration = {};
                                    let configuration = {};
                                    let favorites = {};
                                    $.getq('myq',
                                        'api/v1/getCalibration',
                                        data => {
                                            calibration = data;
                                        }
                                    );
                                    $.getq('myq',
                                        'api/v1/getConfiguration',
                                        data => {
                                            configuration = data;
                                        }
                                    );
                                    $.postq('myq',
                                        'api/v1/favorites/getAll',
                                        data => {
                                            favorites = data;
                                        }
                                    );
                                    let nreceived = 0;
                                    let nRetry = 0;
                                    let el;
                                    let cbFcn = rdata => {
                                        presets.push(rdata);
                                        nreceived++;
                                        console.log('Received ' + nreceived + ' of ' + data.length + ' presets');
                                        ons.notification.toast('Received plugin data ' + nreceived + ' out of ' + data.length, {
                                            timeout: 250,
                                            animation: 'none'
                                        });
                                        // if last request not completed spawn next
                                        if(nreceived < data.length){
                                            getPresetData();
                                            return;
                                        }
                                        let zip = new JSZip();
                                        presets.forEach(el => {
                                            zip.file('mp-' + el.id + '.jsn', JSON.stringify(el.presets));
                                        });
                                        let all = {
                                            presets: presets,
                                            calibration: calibration,
                                            configuration: configuration,
                                            favorites: favorites
                                        }
                                        zip.file('all.jsn', JSON.stringify(all));
                                        zip.generateAsync({type: "blob"})
                                            .then(function (content) {
                                                // see FileSaver.js
                                                saveAs(content, 'presets.zip');
                                                modal_busy.hide();
                                            });
                                    }
                                    function getPresetData(){
                                        el = data[nreceived];
                                        $.getq('myq',
                                            'api/v1/getPresetData/' + el.id,
                                            cbFcn
                                        )
                                        .fail(
                                            () => {
                                                nRetry++;
                                                if(nRetry > 20){
                                                    console.error("Too many retries, aborting!");
                                                    ons.notification.toast('Too many retries, aborting!', {
                                                        timeout: 500,
                                                        animation: 'none'
                                                    });
                                                    modal_busy.hide();
                                                    return;
                                                }
                                                console.error("Error getting preset data for plugin " + el.id + " retrying...");
                                                getPresetData();
                                            }
                                        );
                                    }
                                    getPresetData();
                                }
                            );
                        });
                    });
                    $('#reboot').on('click', function () {
                        $.getq('myq',
                            '/api/v1/reboot',
                            {'calibration': '0'}
                        );
                        ons.notification.toast('Software reboot!', {
                            timeout: 3000,
                            animation: 'fall'
                        });
                    });
                    $('#upload-backup').click(function () {
                        ons.notification.toast('Select all.jsn!', {
                            timeout: 3000,
                            animation: 'fall'
                        });
                        $('#uploadBackup').trigger('click');
                    });
                    $('#uploadBackup').on('change', function () {
                        if ($('#uploadBackup').prop('files')[0] == undefined) return;
                        if ($('#uploadBackup').prop('files')[0] == '') return;
                        if ($('#uploadBackup').prop('files')[0] == 0) return;
                        let reader = new FileReader();
                        reader.onload = function (event) {
                            let contents = event.target.result;
                            let jsn = JSON.parse(contents);
                            $('#uploadBackup').val('');
                            performUploadBackup(jsn);
                        }
                        reader.readAsText($('#uploadBackup').prop('files')[0]);
                    });
                }
            );

            this.onShow = function () {
                //console.log('Main');
            };
            // async script loader
            function loadScript(url, cb) {
                let isLoaded = document.querySelectorAll('.search-script');
                if(isLoaded.length > 0) {
                    cb();
                    return;
                }

                let myScript = document.createElement("script");
                myScript.src = url;
                myScript.className = 'search-script';
                myScript.onload = cb;
                document.body.appendChild(myScript);
            }
            function performUploadBackup(data){
                // console.log(JSON.stringify(data.calibration));
                modal_busy.show();
                if(data.calibration !== null){
                    $.ajaxq('myq', {
                        url: '/api/v1/setCalibration',
                        type: 'post',
                        data: JSON.stringify(data.calibration),
                        success: function () {
                            ons.notification.toast('Calibration data persisted!', {
                                timeout: 250,
                                animation: 'fall'
                            });
                        },
                        error: function () {
                            ons.notification.toast('Error persisting calibration data!', {
                                timeout: 250,
                                animation: 'fall'
                            });
                        }
                    });
                }
                if(data.configuration !== null){
                    $.ajaxq('myq', {
                        url: '/api/v1/setConfiguration',
                        type: 'post',
                        data: JSON.stringify(data.configuration),
                        success: function () {
                            ons.notification.toast('Configuration data persisted!', {
                                timeout: 250,
                                animation: 'fall'
                            });
                        },
                        error: function () {
                            ons.notification.toast('Error persisting configuration data!', {
                                timeout: 250,
                                animation: 'fall'
                            });
                        }
                    });
                }
                if(Array.isArray(data.favorites)){
                    for(let i in data.favorites){
                        $.ajaxq('myq', {
                            url: '/api/v1/favorites/store/' + i,
                            type: 'post',
                            data: JSON.stringify(data.favorites[i]),
                            success: function () {
                                console.log('Favorite ' + i + ' persisted!');
                            },
                            error: function () {
                                ons.notification.toast('Error persisting favorite ' + i + ' !', {
                                    timeout: 250,
                                    animation: 'fall'
                                });
                            }
                        });
                    }
                }
                let presets = data.presets;
                // loading void on both channels, to conserve memory
                $.getq('myq',
                    'api/v1/setActivePlugin/0?id=Void'
                );
                $.getq('myq',
                    'api/v1/setActivePlugin/1?id=Void'
                );
                let numberRetries = 0;
                let aborted = false;
                function recursiveIterate(presets_){
                    if(numberRetries >= 10){
                        if(!aborted){
                            console.log('Too many retries, aborting!');
                            ons.notification.toast('Too many retries, aborting!', {
                                timeout: 500,
                                animation: 'none'
                            });
                            setInterval( () => {
                                modal_busy.hide();
                                location.reload();
                            }, 500);
                        }
                        aborted = true;
                        return;
                    }
                    plugin = presets_.shift(); // take first element
                    if(plugin === undefined){ // iteration finished
                        modal_busy.hide();
                        location.reload();
                        return;
                    }
                    // log plugin id
                    console.log('Restoring data from plugin ' + plugin.id);
                    if(plugin.presets.patches.length === 0){
                        console.error('No preset data for plugin ' + plugin.id);
                        return;
                    }
                    $.getq('myq',
                        '/api/v1/getPresetData/' + plugin.id,
                        data => {
                            let error = false;
                            // log data id and plugin id
                            console.log('Plugin ' + plugin.id + ' verified data id ' + data.id + ' ' + (plugin.id===data.id).toString());
                            ons.notification.toast('Verifying plugin ' + plugin.id, {
                                timeout: 250,
                                animation: 'none'
                            });
                            // check for errors
                            if(typeof data != "object"){
                                console.error('Plugin not available: ' + plugin.id);
                                error = true;
                            }
                            if(!data.hasOwnProperty('presets')){
                                console.error('getPresetsResponse Error: ' + plugin.id);
                                numberRetries++;
                                presets_.push(plugin);
                                recursiveIterate(presets_);
                                return;
                            }
                            if(data.presets.patches.length === 0){
                                console.error('No patches available in plugin ' + plugin.id);
                                error = true;
                            }
                            if(data.presets.patches[0].params.length === 0){
                                console.error('No patches available in plugin ' + plugin.id);
                                error = true;
                            }
                            // check for parameters not available in backup data set and add
                            data.presets.patches[0].params.forEach(param => {
                                plugin.presets.patches.forEach( p => {
                                    const found = p.params.find(({id}) => id === param.id);
                                    if(found === undefined){
                                        console.error('Unknown new parameter ' + param.id);
                                        //p.params.push(param);
                                        error = true;
                                    }
                                });
                            });
                            // check for parameters not available on available plugin of TBD HW and drop
                            plugin.presets.patches.forEach(p => {
                                p.params = p.params.filter(param => {
                                    const found = data.presets.patches[0].params.find(({id}) => id === param.id);
                                    if(found === undefined){
                                        console.error('Patch has old parameter ' + param.id);
                                        error = true;
                                    }
                                    return found !== undefined;
                                });
                            });
                            if(error){
                                ons.notification.toast('Error: Plugin ' + plugin.id + ' not restored!', {
                                    timeout: 250,
                                    animation: 'none'
                                });
                                // do not reiterate current plugin
                                recursiveIterate(presets_);
                                return;
                            }
                            // overwrite existing preset storage
                            console.log('spawning post for plugin ' + plugin.id);
                            $.post('/api/v1/setPresetData/' + plugin.id,
                                JSON.stringify(plugin.presets),
                                data => {
                                    // log data id and plugin id
                                    console.log('Post response received: ' + data);
                                    if(typeof data !== "object"){
                                        console.error('Error restoring plugin ' + plugin.id);
                                        console.error('Pushing back to queue');
                                        presets_.push(plugin);
                                    }
                                    if(data.id !== plugin.id){
                                        console.error('Error restoring plugin ' + plugin.id + ' data id mismatch: ' + data.id);
                                        console.error('Pushing back to queue');
                                        presets_.push(plugin);
                                    }
                                    ons.notification.toast('Remaining data sets: ' + presets_.length, {
                                        timeout: 250,
                                        animation: 'none'
                                    });
                                    recursiveIterate(presets_);
                                }
                            ).fail(
                                () => {
                                    numberRetries++;
                                    console.error('Hard error set preset data, restoring plugin ' + plugin.id);
                                    console.error('Possibly the socket closed? Retrying...');
                                    presets_.push(plugin);
                                    recursiveIterate(presets_);
                                }
                            );
                        }
                    ).fail(
                        () => {
                            numberRetries++;
                            console.error('Hard error restoring get preset data, plugin ' + plugin.id);
                            console.error('Possibly the socket closed? Retrying...');
                            presets_.push(plugin);
                            recursiveIterate(presets_);
                        }
                    );
                }
                recursiveIterate(presets);
            }
        };
    </script>
</ons-page>