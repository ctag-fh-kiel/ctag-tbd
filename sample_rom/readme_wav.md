# Audio Sample Prep and Bank Builder

This document explains two pieces in this folder:

- `wav_info_parser.py` — scans your WAV library, validates/normalizes audio, and produces a compact set of converted files + metadata.
- `index.html` — a static, local web app to audition those files, select up to 128 samples, and export a bank JSON.

Both are designed to produce data compatible with a mono, 16‑bit, 44.1 kHz playback engine.

---

## 1) Convert and prepare samples with `wav_info_parser.py`

### What it does

- Recursively finds all `.wav/.WAV` files under the folder.
- Parses RIFF/WAVE metadata robustly (handles PCM and IEEE float formats); records sample rate, bit depth, channels, data offset, and RIFF INFO tags.
- Copies or converts each file to a target format (44,100 Hz, mono, 16‑bit PCM) into `tbdsamples/`, preserving subfolders.
  - Stereo → mono downmix
  - Sample rate conversion to 44.1 kHz
  - Bit‑depth conversion to 16‑bit PCM
  - IEEE float (format 3) is supported; compressed codecs are not (see Troubleshooting).
- Shortens destination filenames to a readable, normalized stem of at most 32 characters; de‑duplicates with `_2`, `_3`, … when needed.
- Produces metadata JSON files with both a full report for all scanned files and a compact listing for the converted/copyable set.
- Warns if something cannot be processed and explains why (saved to `tbdsamples/conversion_warnings.txt`).

### Requirements

- Python 3.10+ (tested without `audioop` on 3.13; no external decoder required).
- Optional (faster resampling): `numpy`

Install `numpy` (optional):

```bash
python3 -m pip install --user numpy
```

### Run

From the `sample_folder` directory:

```bash
python3 wav_info_parser.py
```

This will:

- Create/update `tbdsamples/` and write converted or copied WAVs (directory structure preserved; filenames shortened to ≤32 chars).
- Write `wav_info.json` (full report) at `wav_info.json`.
- Write `wav_info_short.json` (short report) at `tbdsamples/wav_info_short.json`.
- If any file failed to copy/convert, write explanations to `tbdsamples/conversion_warnings.txt` and print a summary.

For a clean run (avoid accumulating previous copies):

```bash
rm -rf tbdsamples
python3 wav_info_parser.py
```

### Outputs and data shapes

- `wav_info.json` — array of objects for ALL discovered WAVs (converted or not):
  - `filename` (string): source stem (no extension)
  - `path` (string): subdirectory path relative to `sample_folder` (empty if at root)
  - `sample_rate` (number | null)
  - `sample_resolution` (number | null): bits per sample
  - `channels` (number | null)
  - `mono` (boolean): true if 1 channel
  - `nsamples` (number | null): total sample frames (FACT chunk or derived from data length)
  - `offset` (number | null): byte offset to start of data in the original file
  - `format_ok` (boolean): true iff file is already 44.1 kHz, mono, 16‑bit PCM
  - `meta_data` (object): RIFF INFO tags if present
  - `error` (string, optional): set only when parsing failed

- `tbdsamples/wav_info_short.json` — array of objects for files placed in `tbdsamples/` (copied or converted):
  - `filename` (string): DESTINATION stem (shortened ≤32 chars, no extension)
  - `path` (string): subdirectory under `tbdsamples/` (relative to that folder)
  - `nsamples` (number): frames in the placed file
  - `offset` (number, optional): included only when not 44; omitted for standard PCM with a 44‑byte header

Notes:
- The destination audio files reside at `tbdsamples/<path>/<filename>.<original extension case>`.
- The `filename` in the short JSON refers to the shortened destination stem.

### Warnings and failures

If conversion/copy fails for a file, you’ll see a console warning and a line in:

- `tbdsamples/conversion_warnings.txt`

Common causes:
- Big‑endian RIFX WAV (not supported) — use an external tool (e.g., `ffmpeg`) to convert to RIFF PCM first.
- Compressed codecs (e.g., ADPCM) — the built‑in path reads PCM/float; use `ffmpeg` to decode to PCM.

---

## 2) Build your bank with the static web app (`index.html`)

Open the app and pick your prepared folder. You can audition and assemble a bank of up to 128 samples with capacity constraints.

### Open the app

- Direct open usually works (uses the File Picker API):
  - Double‑click `index.html`
- For best compatibility (and to enable “Save to folder”), serve over localhost:

```bash
cd sample_folder
python3 -m http.server 8000
open http://localhost:8000/index.html
```

### Workflow

1) Click “Pick tbdsamples folder…” and select the folder generated by the parser (must contain `wav_info_short.json` and the WAVs).
2) Left panel shows available files grouped by subfolders (collapsible folders), sorted by path/name.
   - Hover to preview (Autopreview must be ON).
   - Background color encodes size: small files are bluish, large files more reddish; items that cannot fit remaining capacity are flagged in red.
   - Click “Add” to move a file to the bank (it disappears from the left list).
3) Right panel lists your bank as a flat list with slots 1..N.
   - Hover to prelisten (when Autopreview ON); click a row to preview regardless of the toggle.
   - Drag and drop rows to reorder slots; numbers update automatically.
4) Capacity line shows Used / Free and the approximate seconds remaining (44.1 kHz, 16‑bit mono at 88,200 bytes/s).
5) Export/Save/Load:
   - “Export JSON” downloads `sample_bank.json`.
   - “Save to folder” writes `sample_bank.json` into a folder you choose (Chromium + secure context required).
   - “Load JSON” restores a previously saved bank (see schema below). Unmatched items are reported; capacity limits are enforced.

### Bank JSON (export/save/load)

The bank is an array of items in slot order. The app exports with the following fields:

```jsonc
[
  {
    "filename": "SOHLER11",      // destination stem, no extension
    "path": "wavetables",        // relative path under tbdsamples (optional for loader)
    "nsamples": 16384,            // frames at 44.1 kHz
    "offset": 512                 // present only when not 44; omitted otherwise
  }
]
```

- Loader matches by `filename` + `nsamples`, and if provided, `offset`. If ambiguous, it falls back to a unique filename match. The `path` field is optional when loading (used only for information).
- The app enforces: up to 128 items and a total payload ≤ 26 MiB. Items exceeding capacity are skipped with a warning.

### Tips

- If hover preview doesn’t play, click the “Autopreview” button to toggle it ON (it performs a one‑time gesture to unlock audio in the browser).
- If a referenced file is missing, the app will warn you and disable preview/add for that entry.
- Use small files for longer total time; at 44.1 kHz/16‑bit mono you get ~88.2 KB/s of audio.

---

## 3) FAQ / Troubleshooting

- “unknown format: 3” (float WAV):
  - The parser now supports IEEE float (format 3) and converts to 16‑bit PCM.
- “Capacity exceeded” warnings in the app:
  - The bank is limited to 26 MiB. Remove or reorder items, or pick smaller ones.
- “Save to folder” button is missing/disabled:
  - The File System Access API requires a Chromium browser and a secure context (https:// or http://localhost). Use the localhost server command shown above.
- Parser didn’t convert a file:
  - Check `tbdsamples/conversion_warnings.txt` for the reason (e.g., unsupported codec, big‑endian, corrupt header).

---

## 4) Quick reference

- Convert and prepare:

```bash
cd sample_folder
python3 wav_info_parser.py
```

- Launch the web app (recommended):

```bash
cd sample_folder
python3 -m http.server 8000
open http://localhost:8000/index.html
```

- Clean conversion run:

```bash
cd sample_folder
rm -rf tbdsamples
python3 wav_info_parser.py
```

---

## 5) File map

- `wav_info_parser.py` — scanner + converter; writes reports and `tbdsamples/`.
- `wav_info.json` — full report for all discovered files.
- `tbdsamples/` — converted/copied WAVs (shortened names; preserved subfolders).
- `tbdsamples/wav_info_short.json` — short listing for files placed in `tbdsamples/`.
- `tbdsamples/conversion_warnings.txt` — reasons why some files failed to copy/convert (if any).
- `index.html` — static web app to build banks from `tbdsamples/`.
- `tbdsamples/sample_bank.json` — output bank JSON if you choose that folder with “Save to folder” (optional).

