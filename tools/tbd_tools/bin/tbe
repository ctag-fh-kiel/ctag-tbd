#!/usr/bin/env bash

qemu_dir=$(pwd)/build/emu

#  -drive file="${qemu_dir}/qemu_efuse.bin,if=none,format=raw,id=efuse" \

tbb emu build \
&& pushd ${qemu_dir} \
&& esptool.py --chip esp32s3 merge_bin --fill-flash-size 16MB -o qemu_flash.bin @flash_args \
&& /opt/qemu/build/qemu-system-xtensa -M esp32s3 \
  -drive file="${qemu_dir}/qemu_flash.bin,if=mtd,format=raw" \
  -global driver=nvram.esp32c3.efuse,property=drive,value=efuse \
  -global driver=timer.esp32s3.timg,property=wdt_disable,value=true \
  -m 8M \
  -nic user,model=open_eth \
  -nographic \
  -serial mon:stdio \
  $@ \
&& popd
