#include <gtest/gtest.h>

#include <tbd/api/packet_writers.hpp>

#include "tbd/api/packet_parser.hpp"


namespace {

struct TEST_CHANNEL {};

const uint8_t SHORT_PACKET[] = {
    0xf0, 0x01, 0x3e, 0x79, 0x0, 0x62, 0x0, 0xe0, 0xd6, 0xe7, 0x73, 0x6f, 0x6d, 0x65, 0x20, 0x6d, 0x65, 0x64, 0x69, 0x75,
    0x6d, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x64, 0x20, 0x70, 0x61, 0x79, 0x6c, 0x6f, 0x61, 0x64, 0x20, 0x74, 0x68, 0x61,
    0x74, 0x20, 0x63, 0x61, 0x6e, 0x20, 0x62, 0x65, 0x20, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x66, 0x65, 0x72, 0x72, 0x65,
    0x64, 0x2c, 0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x77, 0x69, 0x6c, 0x6c, 0x20, 0x6e, 0x6f, 0x74, 0x20, 0x68, 0x69,
    0x74, 0x20, 0x74, 0x68, 0x65, 0x20, 0x75, 0x70, 0x70, 0x65, 0x72, 0x20, 0x70, 0x61, 0x79, 0x6c, 0x6f, 0x61, 0x64,
    0x20, 0x6c, 0x65, 0x6e, 0x67, 0x74, 0x68, 0x20, 0x62, 0x79, 0x74, 0x65, 0xff,
};
const size_t SHORT_PACKET_LENGTH = 109;
const size_t SHORT_PACKET_PAYLOAD_LENGTH = 98;

const uint8_t LONG_PACKET[] = {
    0xf0, 0x2, 0xfe, 0x0, 0x0, 0x22, 0x1, 0xfe, 0x0, 0xe7, 0x73, 0x6f, 0x6d, 0x65, 0x20, 0x6d, 0x65, 0x64, 0x69, 0x75,
    0x6d, 0x20, 0x73, 0x69, 0x7a, 0x65, 0x64, 0x20, 0x70, 0x61, 0x79, 0x6c, 0x6f, 0x61, 0x64, 0x20, 0x74, 0x68, 0x61,
    0x74, 0x20, 0x63, 0x61, 0x6e, 0x20, 0x62, 0x65, 0x20, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x66, 0x65, 0x72, 0x72, 0x65,
    0x64, 0x2c, 0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x77, 0x69, 0x6c, 0x6c, 0x20, 0x68, 0x69, 0x74, 0x20, 0x74, 0x68,
    0x65, 0x20, 0x75, 0x70, 0x70, 0x65, 0x72, 0x20, 0x70, 0x61, 0x79, 0x6c, 0x6f, 0x61, 0x64, 0x20, 0x6c, 0x65, 0x6e,
    0x67, 0x74, 0x68, 0x20, 0x62, 0x79, 0x74, 0x65, 0x2e, 0x2e, 0x2e, 0x73, 0x6f, 0x20, 0x77, 0x65, 0x20, 0x68, 0x61,
    0x76, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x72, 0x61, 0x6d, 0x62, 0x6c, 0x65, 0x20, 0x6f, 0x6e, 0x20, 0x61, 0x6e, 0x64,
    0x20, 0x6f, 0x6e, 0x20, 0x75, 0x6e, 0x74, 0x69, 0x6c, 0x20, 0x77, 0x65, 0x20, 0x68, 0x69, 0x74, 0x20, 0x74, 0x68,
    0x61, 0x74, 0x20, 0x6d, 0x61, 0x67, 0x69, 0x63, 0x61, 0x6c, 0x20, 0x32, 0x35, 0x36, 0x20, 0x62, 0x79, 0x74, 0x65,
    0x20, 0x6d, 0x61, 0x72, 0x6b, 0x20, 0x6a, 0x75, 0x73, 0x74, 0x20, 0x6c, 0x69, 0x6b, 0x65, 0x20, 0x6f, 0x6e, 0x65,
    0x20, 0x6f, 0x66, 0x20, 0x74, 0x68, 0x6f, 0x73, 0x65, 0x20, 0x72, 0x65, 0x61, 0x6c, 0x6c, 0x79, 0x62, 0x6f, 0x72,
    0x69, 0x6e, 0x67, 0x20, 0x62, 0x6f, 0x6f, 0x6b, 0x73, 0x20, 0x77, 0x65, 0x20, 0x61, 0x6c, 0x6c, 0x20, 0x68, 0x61,
    0x64, 0x20, 0x74, 0x6f, 0x20, 0x72, 0x65, 0x61, 0x64, 0x20, 0x61, 0x74, 0x20, 0x73, 0x63, 0x68, 0x6f, 0x6f, 0x6c,
    0x2c, 0x20, 0x77, 0x68, 0x65, 0x6e, 0x20, 0x77, 0x65, 0x20, 0x77, 0x6f, 0x75, 0x6c, 0x64, 0x20, 0x72, 0x61, 0x74,
    0x68, 0x65, 0x72, 0x20, 0x68, 0x61, 0x76, 0x65, 0x20, 0x62, 0x65, 0x65, 0x6e, 0x20, 0x70, 0x6c, 0x61, 0x79, 0x69,
    0x6e, 0x67, 0x20, 0x76, 0x69, 0x64, 0x65, 0x6f, 0x20, 0x67, 0x61, 0x6d, 0x65, 0x73, 0xff,
};

const size_t LONG_PACKET_LENGTH = 301;
const size_t LONG_PACKET_PAYLOAD_LENGTH = 290;

}


TEST(TestPackets, can_deserialize_packet) {
    tbd::api::PacketBufferParser parser(SHORT_PACKET, SHORT_PACKET_LENGTH);

    const auto success = parser.parse();
    EXPECT_EQ(success, true);

    const auto& packet = parser.packet();
    EXPECT_EQ(packet.type, tbd::api::Header::TYPE_RPC);
    EXPECT_EQ(packet.handler, 31038);
    EXPECT_EQ(packet.id, 55008);
    EXPECT_EQ(packet.payload_length, SHORT_PACKET_PAYLOAD_LENGTH);
    EXPECT_EQ(packet.crc, 0);
    for (size_t i = 0; i < SHORT_PACKET_PAYLOAD_LENGTH; i++) {
        EXPECT_EQ(packet.payload[i], SHORT_PACKET[tbd::api::Header::HEADER_SIZE + i]);
    }
}


TEST(TestPackets, can_deserialize_long_packet) {
    tbd::api::PacketBufferParser parser(LONG_PACKET, LONG_PACKET_LENGTH);

    const auto success = parser.parse();
    EXPECT_EQ(success, true);

    const auto& packet = parser.packet();
    EXPECT_EQ(packet.type, tbd::api::Header::TYPE_RESPONSE);
    EXPECT_EQ(packet.handler, 254);
    EXPECT_EQ(packet.id, 254);
    EXPECT_EQ(packet.payload_length, LONG_PACKET_PAYLOAD_LENGTH);
    EXPECT_EQ(packet.crc, 0);
    for (size_t i = 0; i < LONG_PACKET_PAYLOAD_LENGTH; i++) {
        EXPECT_EQ(packet.payload[i], LONG_PACKET[tbd::api::Header::HEADER_SIZE + i]);
    }
}