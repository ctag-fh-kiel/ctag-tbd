#include <atomic>
#include <tbd/sound_processor.hpp>
#include "helpers/ctagSineSource.hpp"
#include "helpers/ctagFastMath.hpp"

// --- VULT "Library for TBD" ---
#include "./vult/vult_formantor.h"
#include "./vult/vult_formantor.tables.h"

using namespace CTAG::SP::HELPERS;

namespace CTAG {
    namespace SP {
        class ctagSoundProcessorRetroactor : public ctagSoundProcessor {
        public:
            virtual void Process(const ProcessData &) override;
           virtual void Init(std::size_t blockSize, void *blockPtr) override;
            virtual ~ctagSoundProcessorRetroactor();

        private:
            virtual void knowYourself() override;

            // --- Remember status of triggers / buttons ---
            inline int process_param_trig( const ProcessData &data, int trig_myparm, int my_parm, int prev_trig_state_id, int gate_type ); // rescale incoming data to bool
            enum trig_states
            {
                e_VintageFilter, e_ResetFeedbackLoop, e_IsolateFeedback, e_SineDisable, e_SineBisDistorted, e_Retroactor_options_max
            };
            int prev_trig_state[e_Retroactor_options_max] = {0};   // Initialize _all_ entries with "low value"
            bool low_reached[e_Retroactor_options_max] = {false};  // We need this for look for toggle-events

            // --- Oscillators ---
            ctagSineSource sine_A;          // To be updated in main loop => smooth
            ctagSineSource rough_sine_B;          // To be updated outside main loop => rough
            ctagSineSource sine_B;          // To be updated outside main loop => rough

            // --- Feedback Loop ---
            float m_feedback_process = 0;
            float m_wavefolder = 0;

            // --- VULT Stuff ---
            Rescomb__ctx_type_6 rescomb_data;           // Resonator (comb-filter) data-structure
            Ladder__ctx_type_8 ladder_data;             // Ladder filter data-structure
            Ladder__ctx_type_6 ladder_vintage_data;     // Euler ladder algorithm

            // --- Target-number for main DSP-Loop ---
            const uint32_t loop_target = bufSz * 2;

            // private attributes could go here
            // autogenerated code here
            // sectionHpp
            std::atomic<int32_t> MasterPitch, cv_MasterPitch;
            std::atomic<int32_t> MasterTune, cv_MasterTune;
            std::atomic<int32_t> Volume, cv_Volume;
            std::atomic<int32_t> PitchSineA, cv_PitchSineA;
            std::atomic<int32_t> FrequSineA, cv_FrequSineA;
            std::atomic<int32_t> SineBisDistorted, trig_SineBisDistorted;
            std::atomic<int32_t> PitchSineB, cv_PitchSineB;
            std::atomic<int32_t> FrequSineB, cv_FrequSineB;
            std::atomic<int32_t> ResetFeedbackLoop, trig_ResetFeedbackLoop;
            std::atomic<int32_t> CombCut, cv_CombCut;
            std::atomic<int32_t> CombRes, cv_CombRes;
            std::atomic<int32_t> CombTone, cv_CombTone;
            std::atomic<int32_t> LadderCut, cv_LadderCut;
            std::atomic<int32_t> LadderRes, cv_LadderRes;
            std::atomic<int32_t> VintageFilter, trig_VintageFilter;
            std::atomic<int32_t> WavefolderAmount, cv_WavefolderAmount;
            std::atomic<int32_t> IsolateFeedback, trig_IsolateFeedback;
            std::atomic<int32_t> SineDisable, trig_SineDisable;
            std::atomic<int32_t> VolSineBoost, cv_VolSineBoost;
            std::atomic<int32_t> VolSineA, cv_VolSineA;
            std::atomic<int32_t> VolSineB, cv_VolSineB;
            std::atomic<int32_t> SineMix, cv_SineMix;
            std::atomic<int32_t> VolFeedbackLoop, cv_VolFeedbackLoop;
            std::atomic<int32_t> VolWavefolder, cv_VolWavefolder;
            // sectionHpp
        };
    }
}